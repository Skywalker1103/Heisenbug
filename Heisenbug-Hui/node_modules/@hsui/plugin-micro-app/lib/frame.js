"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;
var _fsExtra = require("fs-extra");
var _chokidar = _interopRequireDefault(require("chokidar"));
var _path = _interopRequireDefault(require("path"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
const _require = require('../package.json'),
  version = _require.version;
function updateRootStore(vuex, isRootExisted) {
  const root = isRootExisted ? 'require("@/store/root")' : '{}';
  let code = `
import hCore, { frameEmitter, ${vuex ? 'store' : ''} } from "@hsui/core";

`;
  if (vuex) {
    code += `
const _mutations = [];
window?.FRAME_CONFIG?.LOG_LEVEL && (hCore.logger.setLevel(window?.FRAME_CONFIG?.LOG_LEVEL));
window?.FRAME_CONFIG?.LOG_COLLECTION_ENABLE === true && hCore.logger.setConfig && (hCore.logger.setConfig({
  enableLogIndexDB: true
}));
if (frameEmitter) {
  frameEmitter.on("app-store-ready", () => {
    if (store.hasModule("root")) {
      const rawRootModule = ${root};
      frameEmitter.trigger("register-root-module", { root: rawRootModule });
      hCore.log.debug('״̬����ע��״̬ģ��')
      if (_mutations.length) {
        _mutations.forEach((mutation) => {
          frameEmitter.trigger("update-root-module", { mutation, root: rawRootModule });
          hCore.log.debug('״̬����' )
        });
      }
    }
  });

  store.subscribe((mutation, state) => {
    if (${/root\//}.test(mutation.type)) {
      _mutations.push(mutation);
      frameEmitter.trigger("update-root-module", { mutation, root: ${root} });
      hCore.log.debug('״̬����')
    }
  });
}`;
  }
  return code;
}
function _default(api, options = {}) {
  // @tmp/micro-app
  (0, _fsExtra.ensureDirSync)('./src/.hui/micro-app');

  // meta
  api.writeTmpFile('micro-app/meta.js', `export const version = "${version}"`);

  /**
   * frameEmitter
   * onMicroApp
   * triggerMicroApp
   */
  api.addHuiExports([{
    specifiers: '*',
    source: '@tmp/micro-app/registerEmitter.js'
  }]);
  (0, _fsExtra.copyFileSync)(_path.default.resolve(__dirname, '../template/registerEmitter.js'), './src/.hui/micro-app/registerEmitter.js');

  // vuex root module synchronization
  api.writeTmpFile('micro-app/root.js', updateRootStore(options.vuex, (0, _fsExtra.pathExistsSync)('./src/store/root.js')));
  api.addEntryFileBefore('app', '@tmp/micro-app/root.js');
  if (process.env.NODE_ENV === 'development') {
    _chokidar.default.watch('./src/store/root.js').on('add', () => api.writeTmpFile('micro-app/root.js', updateRootStore(options.vuex, true))).on('unlink', () => api.writeTmpFile('micro-app/root.js', updateRootStore(options.vuex, false)));
  }
}